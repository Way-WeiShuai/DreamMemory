<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ‹¼å›¾å¤§å¸ˆ - v4.3 é«˜æ€§èƒ½ç‰ˆ</title>
<style>
:root {
    --primary-color: #4a90e2;
    --bg-dark: #0f0f1e;
    --card-bg: rgba(255, 255, 255, 0.05);
    --silver-grey: #bdc3c7;
    --gold: #f1c40f;
    --success-green: #2ecc71;
}
body {
    font-family: 'PingFang SC', sans-serif;
    background-color: var(--bg-dark);
    color: white;
    margin: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
}
.screen { display: none; width: 100%; max-width: 1000px; padding: 20px; box-sizing: border-box; }
.active { display: flex; flex-direction: column; align-items: center; }
#level-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; width: 100%; margin-top: 20px; }
.level-card { background: var(--card-bg); border-radius: 8px; overflow: hidden; cursor: pointer; }
.card-thumb { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #1a1a2e; font-size: 2.5rem; }
.card-thumb img { width: 100%; height: 100%; object-fit: cover; }
#board-container { padding: 10px; background: #1a1a2e; border-radius: 8px; }
#puzzle-board { display: grid; gap: 0; position: relative; background: #000; }
.piece { background-repeat: no-repeat; }
.btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; background: #333; color: white; }
</style>
</head>
<body>

<div id="menu-screen" class="screen active">
    <h1>ğŸ§© æ‹¼å›¾å¤§å¸ˆ v4.3</h1>
    <div id="level-grid"></div>
</div>

<div id="game-screen" class="screen">
    <button class="btn" onclick="showMenu()">â† èœå•</button>
    <h2 id="game-title"></h2>
    <div id="board-container">
        <div id="puzzle-board"></div>
    </div>
</div>

<script>
/* =========================
   å›¾ç‰‡ç¼“å­˜ç³»ç»Ÿï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
========================= */
const imageCache = new Map();

function preloadImage(url) {
    if (imageCache.has(url)) return imageCache.get(url);

    const img = new Image();
    img.src = url;
    imageCache.set(url, img);
    return img;
}

/* ========================= */

let levelData = [];
let completedLevels = JSON.parse(localStorage.getItem('puz_comp_v31') || '[]');

let currentImgUrl = '';
let currentLevelId = 1;
let rows, cols, pWidth, pHeight;
let pieces = [];

/* =========================
   ç²¾ç®€ discoverLevels
========================= */
function discoverLevels() {
    const currentMax = completedLevels.length > 0 ? Math.max(...completedLevels) : 0;
    const targetLimit = currentMax + 5;

    levelData = [];
    for (let i = 1; i <= targetLimit; i++) {
        const url = `${i}.webp`;
        levelData.push({ id: i, url });

        // æå‰é¢„åŠ è½½
        preloadImage(url);
    }

    renderMenu();
}

/* ========================= */

function renderMenu() {
    const grid = document.getElementById('level-grid');
    grid.innerHTML = '';

    levelData.forEach(level => {
        const isUnlocked = level.id === 1 || completedLevels.includes(level.id - 1);
        const card = document.createElement('div');
        card.className = 'level-card';

        if (isUnlocked) {
            card.innerHTML = `<div class="card-thumb"><img src="${level.url}"></div>`;
            card.onclick = () => startLevel(level.id);
        } else {
            card.innerHTML = `<div class="card-thumb">ğŸ”’</div>`;
        }

        grid.appendChild(card);
    });
}

/* =========================
   ç²¾ç®€ startLevel + è§£ç ä¼˜åŒ–
========================= */
function startLevel(levelId) {
    currentLevelId = levelId;
    currentImgUrl = `${levelId}.webp`;

    const img = preloadImage(currentImgUrl);

    img.onload = () => {
        // å¼ºåˆ¶è§£ç ï¼Œé¿å…ç»˜åˆ¶æ—¶å¡é¡¿
        if (img.decode) {
            img.decode().catch(() => {});
        }

        const ratio = img.naturalWidth / img.naturalHeight;
        rows = cols = Math.min(8, 3 + Math.floor((levelId - 1) / 3));

        const maxW = Math.min(window.innerWidth * 0.9, 700);
        const maxH = window.innerHeight * 0.65;

        pWidth = Math.floor(maxW / cols);
        pHeight = Math.floor((maxW / ratio) / rows);

        if (pHeight * rows > maxH) {
            pHeight = Math.floor(maxH / rows);
            pWidth = Math.floor((maxH * ratio) / cols);
        }

        initBoard();

        document.getElementById('menu-screen').classList.remove('active');
        document.getElementById('game-screen').classList.add('active');
        document.getElementById('game-title').innerText = `Level ${levelId}`;

        // é¢„åŠ è½½ä¸‹ä¸€å…³
        preloadImage(`${levelId + 1}.webp`);
    };
}

/* ========================= */

function initBoard() {
    pieces = [];
    for (let i = 0; i < rows * cols; i++) {
        pieces.push({
            id: i,
            currentPos: i,
            bgX: (i % cols) * pWidth,
            bgY: Math.floor(i / cols) * pHeight
        });
    }

    let pool = [...Array(rows * cols).keys()].sort(() => Math.random() - 0.5);
    pieces.forEach((p, i) => p.currentPos = pool[i]);

    renderPieces();
}

function renderPieces() {
    const board = document.getElementById('puzzle-board');
    board.innerHTML = '';
    board.style.width = `${pWidth * cols}px`;
    board.style.height = `${pHeight * rows}px`;
    board.style.gridTemplateColumns = `repeat(${cols}, ${pWidth}px)`;

    pieces.sort((a,b) => a.currentPos - b.currentPos).forEach(p => {
        const div = document.createElement('div');
        div.className = 'piece';
        div.style.width = `${pWidth}px`;
        div.style.height = `${pHeight}px`;

        // ä½¿ç”¨ç¼“å­˜å›¾ç‰‡ï¼ˆé¿å…é‡å¤è§£ç ï¼‰
        div.style.backgroundImage = `url(${currentImgUrl})`;
        div.style.backgroundPosition = `-${p.bgX}px -${p.bgY}px`;
        div.style.backgroundSize = `${pWidth * cols}px ${pHeight * rows}px`;

        board.appendChild(div);
    });
}

function showMenu() {
    document.getElementById('game-screen').classList.remove('active');
    document.getElementById('menu-screen').classList.add('active');
    renderMenu();
}

/* ========================= */

discoverLevels();
</script>

</body>
</html>
